<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Impacto de Meteoro - S√£o Paulo</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            max-width: 300px;
        }

        #controls button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #controls button:hover {
            background: #ff6666;
        }

        #impact-info {
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <div id="controls">
        <h3>Meteor Impact Simulator</h3>
        <button onclick="simulateImpact()">Simulate Impact</button>
        <button onclick="resetSimulation()">Reset</button>
        <div id="impact-info">
            <strong>Location:</strong> S√£o Paulo, Brazil<br>
            <strong>Diameter:</strong> 50m<br>
            <strong>Speed:</strong> 20 km/s<br>
            <strong>Energy:</strong> ~1 Megatons TNT<br>
            <br>
            <em>üí° Click on the map to choose the target!</em>
        </div>
    </div>

    <script>
        // Token de acesso do Cesium ion
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjMGRkYjMwYy1lODg0LTQ3MTktOTBiNi02ZDI0YjRiNTcxNjIiLCJpZCI6MzQ3MjQ2LCJpYXQiOjE3NTk2MDg1NzN9.901R3lkV1aC6zsOj843KhI37YOCw7lOnqS8rHd4nVq8';

        // --- PAR√ÇMETROS DA CRATERA ---
        let craterMajorRadius = 1500;
        let craterMinorRadius = 1500;
        let craterDepth = 400;
        let craterRotation = 45;
        let craterCapCutoffHeight = 0;

        // Vari√°veis globais
        let viewer;
        let meteorEntity;
        let explosionEntity;
        let impactZones = [];
        let SAO_PAULO = { longitude: -46.633, latitude: -23.55 };
        let targetMarker = null;
        let craterModel = null;
        let terrainHeight = 0;

        // Legendas
        const labelAlpha = 0.9;
        const labelBrightness = 1;

        // Crater
        const craterModelUri = "./crater_with_cone_fixed.glb";

        // Aguarda o DOM estar pronto
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(),
                    sceneModePicker: false,
                    animation: false,
                    timeline: false,
                });

                // Camada adicional de labels
                const labelsLayer = viewer.imageryLayers.addImageryProvider(
                    new Cesium.OpenStreetMapImageryProvider({
                        url: 'https://cartodb-basemaps-a.global.ssl.fastly.net/light_only_labels/',
                        fileExtension: 'png',
                        credit: 'CartoDB'
                    })
                );
                labelsLayer.alpha = labelAlpha;
                labelsLayer.brightness = labelBrightness;

                viewer.cesiumWidget.creditContainer.style.display = "none";
                viewer.scene.globe.depthTestAgainstTerrain = true;

                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 80000),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-90.0),
                        roll: 0.0
                    },
                    duration: 3
                });

                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude),
                    point: {
                        pixelSize: 15,
                        color: Cesium.Color.CYAN,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    }
                });

                // Adiciona handler de clique no mapa
                const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
                handler.setInputAction(function (movement) {
                    const cartesian = viewer.scene.pickPosition(movement.position);

                    if (Cesium.defined(cartesian)) {
                        const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                        const longitude = Cesium.Math.toDegrees(cartographic.longitude);
                        const latitude = Cesium.Math.toDegrees(cartographic.latitude);
                        const height = cartographic.height;

                        terrainHeight = height;

                        console.log(`Alvo definido em: Lon ${longitude.toFixed(3)}, Lat ${latitude.toFixed(3)}, Altura: ${height.toFixed(2)} metros`);

                        SAO_PAULO.longitude = longitude;
                        SAO_PAULO.latitude = latitude;

                        if (targetMarker) {
                            viewer.entities.remove(targetMarker);
                        }

                        targetMarker = viewer.entities.add({
                            position: cartesian,
                            point: {
                                pixelSize: 20,
                                color: Cesium.Color.RED,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 3,
                                heightReference: Cesium.HeightReference.NONE
                            },
                            label: {
                                text: `ALVO\n${height.toFixed(0)} m`,
                                font: '14pt Arial',
                                pixelOffset: new Cesium.Cartesian2(0, -30),
                                fillColor: Cesium.Color.WHITE,
                                outlineColor: Cesium.Color.RED,
                                outlineWidth: 2,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                backgroundColor: Cesium.Color.RED.withAlpha(0.7),
                                backgroundPadding: new Cesium.Cartesian2(5, 5)
                            }
                        });
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            } catch (error) {
                console.error('Erro ao inicializar simulador:', error);
            }
        });

        // Fun√ß√£o para simular o impacto do meteoro
        function simulateImpact() {
            resetSimulation();
            createMeteor();
            setTimeout(() => {
                createExplosion();
                removeMeteor();
            }, 3000);
            setTimeout(() => {
                const impactPosition = Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude);
                createCraterWithTerrain(impactPosition, craterMajorRadius, craterDepth);
                removeExplosion();
            }, 4000);
            setTimeout(createDestructionZones, 6000);
        }

        // Fun√ß√£o para criar cratera
        function createCraterWithTerrain(position, radius, depth) {
            // 1. Corta o terreno em formato circular
            const clippingPlanes = [];
            const numSides = 64;
            const points = [];

            for (let i = 0; i < numSides; i++) {
                const angle = Cesium.Math.TWO_PI * (i / numSides);
                points.push(new Cesium.Cartesian2(
                    radius * Math.cos(angle),
                    radius * Math.sin(angle)
                ));
            }

            for (let i = 0; i < numSides; i++) {
                const j = (i + 1) % numSides;
                const mid = Cesium.Cartesian2.multiplyByScalar(
                    Cesium.Cartesian2.add(points[i], points[j], new Cesium.Cartesian2()),
                    0.5, new Cesium.Cartesian2()
                );
                const normal = Cesium.Cartesian2.normalize(
                    Cesium.Cartesian2.subtract(points[j], points[i], new Cesium.Cartesian2()),
                    new Cesium.Cartesian2()
                );
                const tmp = normal.x;
                normal.x = -normal.y;
                normal.y = tmp;

                clippingPlanes.push(
                    new Cesium.ClippingPlane(new Cesium.Cartesian3(normal.x, normal.y, 0.0), -Cesium.Cartesian2.magnitude(mid))
                );
            }

            clippingPlanes.push(new Cesium.ClippingPlane(new Cesium.Cartesian3(0.0, 0.0, -1.0), terrainHeight - (depth)));

            viewer.scene.globe.clippingPlanes = new Cesium.ClippingPlaneCollection({
                planes: clippingPlanes,
                edgeWidth: 2.0,
                edgeColor: Cesium.Color.DARKRED,
                modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position),
                enabled: true
            });

            // 2. Adiciona o modelo GLB da cratera
            if (craterModel) {
                viewer.entities.remove(craterModel);
                craterModel = null;
            }

            const cartographic = Cesium.Cartographic.fromCartesian(position);
            const longitude = Cesium.Math.toDegrees(cartographic.longitude);
            const latitude = Cesium.Math.toDegrees(cartographic.latitude);

            const centeredPosition = Cesium.Cartesian3.fromDegrees(
                longitude,
                latitude,
                terrainHeight - (depth * 8.9)
            );

            // Escala proporcional ao raio da cratera
            const craterScale = radius * 25; // Dividido por 100 para tamanho realista

            craterModel = viewer.entities.add({
                position: centeredPosition,
                model: {
                    uri: craterModelUri,
                    scale: craterScale,
                    minimumPixelSize: 64,
                    maximumScale: craterScale * 2,
                    color: Cesium.Color.GRAY
                }
            });

            console.log(`Cratera carregada em lon:${longitude.toFixed(3)}, lat:${latitude.toFixed(3)}, altura:${terrainHeight.toFixed(2)}m`);
        }

        function resetSimulation() {
            if (meteorEntity) viewer.entities.remove(meteorEntity);
            if (explosionEntity) viewer.entities.remove(explosionEntity);
            if (craterModel) {
                viewer.entities.remove(craterModel);
                craterModel = null;
            }

            meteorEntity = explosionEntity = null;

            impactZones.forEach(zone => viewer.entities.remove(zone));
            impactZones = [];

            if (viewer.scene.globe.clippingPlanes) {
                viewer.scene.globe.clippingPlanes.enabled = false;
                viewer.scene.globe.clippingPlanes = undefined;
            }

            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 80000),
                orientation: {
                    heading: Cesium.Math.toRadians(0.0),
                    pitch: Cesium.Math.toRadians(-90.0),
                    roll: 0.0
                },
                duration: 2
            });
        }

        function createMeteor() {
            const startTime = viewer.clock.currentTime;
            const endTime = Cesium.JulianDate.addSeconds(startTime, 3, new Cesium.JulianDate());
            const startPosition = Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude - 1, SAO_PAULO.latitude + 1, 150000);
            const endPosition = Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 0);

            const positionProperty = new Cesium.SampledPositionProperty();
            positionProperty.addSample(startTime, startPosition);
            positionProperty.addSample(endTime, endPosition);

            meteorEntity = viewer.entities.add({
                name: "Meteoro",
                position: positionProperty,
                point: {
                    pixelSize: 35,
                    color: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 4,
                    scaleByDistance: new Cesium.NearFarScalar(1000, 2, 100000, 0.5)
                },
                path: {
                    show: true,
                    leadTime: 0,
                    trailTime: 2,
                    width: 10,
                    resolution: 1,
                    material: new Cesium.PolylineGlowMaterialProperty({
                        glowPower: 0.5,
                        color: Cesium.Color.ORANGE,
                        taperPower: 0.7
                    })
                },
                label: {
                    text: "‚òÑÔ∏è METEORO",
                    font: "12pt Arial",
                    pixelOffset: new Cesium.Cartesian2(0, -30),
                    fillColor: Cesium.Color.YELLOW,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE
                }
            });

            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 60000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-90),
                    roll: 0
                }
            });
        }

        function removeMeteor() {
            if (meteorEntity) {
                viewer.entities.remove(meteorEntity);
                meteorEntity = null;
            }
        }

        function createExplosion() {
            explosionEntity = viewer.entities.add({
                name: "Explos√£o",
                position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 1000),
                ellipse: {
                    semiMinorAxis: 5000,
                    semiMajorAxis: 5000,
                    height: 1000,
                    material: new Cesium.ColorMaterialProperty(
                        new Cesium.CallbackProperty(function (time, result) {
                            const intensity = Math.sin(Cesium.JulianDate.secondsDifference(time, viewer.clock.currentTime) * 10) * 0.5 + 0.5;
                            return Cesium.Color.ORANGE.withAlpha(intensity * 0.8);
                        }, false)
                    ),
                    outline: true,
                    outlineColor: Cesium.Color.RED
                },
                label: {
                    text: "üí• IMPACTO!",
                    font: "16pt Arial",
                    pixelOffset: new Cesium.Cartesian2(0, -20),
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE
                }
            });
        }

        function removeExplosion() {
            if (explosionEntity) {
                viewer.entities.remove(explosionEntity);
                explosionEntity = null;
            }
        }

        function createDestructionZones() {
            // Zona vermelha - destrui√ß√£o total
            const redZone = viewer.entities.add({
                name: "Destrui√ß√£o Total",
                position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude),
                ellipse: {
                    semiMinorAxis: 5000,
                    semiMajorAxis: 5000,
                    material: Cesium.Color.RED.withAlpha(0.3),
                    outline: true,
                    outlineColor: Cesium.Color.DARKRED,
                    outlineWidth: 3,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: "ZONA VERMELHA\nDestrui√ß√£o Total",
                    font: "12pt Arial",
                    pixelOffset: new Cesium.Cartesian2(0, -20),
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    backgroundColor: Cesium.Color.RED.withAlpha(0.7),
                    backgroundPadding: new Cesium.Cartesian2(5, 5)
                }
            });

            // Zona laranja - destrui√ß√£o severa
            const orangeZone = viewer.entities.add({
                name: "Destrui√ß√£o Severa",
                position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude),
                ellipse: {
                    semiMinorAxis: 15000,
                    semiMajorAxis: 15000,
                    material: Cesium.Color.ORANGE.withAlpha(0.2),
                    outline: true,
                    outlineColor: Cesium.Color.DARKORANGE,
                    outlineWidth: 2,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: "ZONA LARANJA\nDestrui√ß√£o Severa",
                    font: "12pt Arial",
                    pixelOffset: new Cesium.Cartesian2(100, 50),
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.ORANGE,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    backgroundColor: Cesium.Color.ORANGE.withAlpha(0.7),
                    backgroundPadding: new Cesium.Cartesian2(5, 5)
                }
            });

            // Zona amarela - danos moderados
            const yellowZone = viewer.entities.add({
                name: "Danos Moderados",
                position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude),
                ellipse: {
                    semiMinorAxis: 30000,
                    semiMajorAxis: 30000,
                    material: Cesium.Color.YELLOW.withAlpha(0.15),
                    outline: true,
                    outlineColor: Cesium.Color.GOLD,
                    outlineWidth: 2,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: "ZONA AMARELA\nDanos Moderados",
                    font: "12pt Arial",
                    pixelOffset: new Cesium.Cartesian2(-100, 100),
                    fillColor: Cesium.Color.BLACK,
                    outlineColor: Cesium.Color.YELLOW,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    backgroundColor: Cesium.Color.YELLOW.withAlpha(0.7),
                    backgroundPadding: new Cesium.Cartesian2(5, 5)
                }
            });

            impactZones.push(redZone, orangeZone, yellowZone);

            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 120000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-90),
                    roll: 0
                },
                duration: 3
            });
        }
    </script>
</body>

</html>